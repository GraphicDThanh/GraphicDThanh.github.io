<p><img src="/assets/images/2023/10/2023-10-relation-fields-in-drf-serializer-cover.png" alt="" />
The Django model offers various types of relationships such as OneToOneField, ForeignKey, ManyToManyField, and GenericForeignKey.</p>

<p>To present or write data of relationship in a serializer, you can utilize DRF Relation fields.</p>

<p>In this post, I will summarize the key points of relational fields and then delve into customizing a relation field to facilitate reading and writing relationship data.</p>

<p>Although the <a href="https://www.django-rest-framework.org/api-guide/relations/#serializer-relations">official document</a> mentions this custom relational topic, it lacks examples and use cases. Therefore, I aim to make it more practical by providing relevant illustrations.</p>

<p>Before we delve into the content, let’s take a look at the relevant models:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Album</span><span class="p">(</span><span class="n">models</span><span class="p">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">album_name</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Track</span><span class="p">(</span><span class="n">models</span><span class="p">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">album</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">ForeignKey</span><span class="p">(</span>
        <span class="n">Album</span><span class="p">,</span>
        <span class="n">related_name</span><span class="o">=</span><span class="s">'tracks'</span><span class="p">,</span>
        <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="p">.</span><span class="n">CASCADE</span>
    <span class="p">)</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">duration</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">IntegerField</span><span class="p">()</span>
</code></pre></div></div>

<h2 id="performance-concerns-related-to-relation-fields-and-the-responsibility-of-developers">Performance concerns related to relation fields and the responsibility of developers</h2>

<p>When using Django REST Framework (DRF), it is important to note that DRF <strong>does not automatically optimize the queryset that is passed to the serializer</strong>.</p>

<p>It is the responsibility of the developer to optimize the performance of relation fields in DRF. By using methods like prefetch_related and select_related, developers can improve the efficiency of their queries and enhance the overall performance of their applications.</p>

<p>With above models, if we have <em>AlbumSerializer</em>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">AlbumSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="p">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
    <span class="n">tracks</span> <span class="o">=</span> <span class="n">serializers</span><span class="p">.</span><span class="n">StringRelatedField</span><span class="p">(</span><span class="n">many</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>


    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Album</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s">'album_name'</span><span class="p">,</span> <span class="s">'tracks'</span><span class="p">]</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">AlbumSerializer</span><span class="p">(</span><span class="n">Album</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="nb">all</span><span class="p">(),</span> <span class="n">many</span><span class="o">=</span><span class="bp">True</span><span class="p">).</span><span class="n">data</span>
</code></pre></div></div>

<p>then serializer all albums as above.</p>

<p>This cause <strong>serious performance issues</strong> since it will hit database N times with N is total number of albums.</p>

<p>It is important to address the issue of hitting the database multiple times, which can cause <strong>serious performance issues</strong>.</p>

<p>By using <code class="language-plaintext highlighter-rouge">Album.objects.prefetch_related('tracks')</code> , developers can optimize the performance by fetching the related tracks in a single database query. This reduces the number of round trips to the database and improves the overall performance of the serializer.</p>

<h2 id="relation-fields-readonly-built-in">Relation fields readonly built-in</h2>

<p>DRF provides relation fields readonly includes:</p>

<p>– <strong>StringRelatedField</strong></p>

<p>– <strong>HyperlinkedIdentityField</strong></p>

<h2 id="relation-fields-read-write-built-in">Relation fields read-write built-in</h2>

<p>DRF provides relation fields read-write includes:</p>

<p>– PrimaryKeyRelatedField</p>

<p>– HyperlinkedRelatedField</p>

<p>– SlugRelatedField</p>

<p>If you want these readonly, add param read_only=True in the field.</p>

<p>For mor detail about these built-in fields, please read the <a href="https://www.django-rest-framework.org/api-guide/relations/">official document</a>.</p>

<h2 id="nested-serializer">Nested serializer</h2>

<p>For nested relationship, you could use its own serializer. By default, nested serializer is readonly.</p>

<p>For example, Track has serializer TrackSerializer then could use:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">tracks</span> <span class="o">=</span> <span class="n">TrackSerializer</span><span class="p">(</span><span class="n">many</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">read_only</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</code></pre></div></div>

<p>Above is how to present data. If you want to write into nested relationship, you could use method create() or update() to write.</p>

<p>For example, when create an album, you also want to write tracks, then:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">validated_data</span><span class="p">):</span>
    <span class="n">tracks_data</span> <span class="o">=</span> <span class="n">validated_data</span><span class="p">.</span><span class="n">pop</span><span class="p">(</span><span class="s">'tracks'</span><span class="p">)</span>
    <span class="n">album</span> <span class="o">=</span> <span class="n">Album</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="o">**</span><span class="n">validated_data</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">track_data</span> <span class="ow">in</span> <span class="n">tracks_data</span><span class="p">:</span>
        <span class="n">Track</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="n">album</span><span class="o">=</span><span class="n">album</span><span class="p">,</span> <span class="o">**</span><span class="n">track_data</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">album</span>
</code></pre></div></div>

<h2 id="custom-relation-fields">Custom relation fields</h2>
<p>In some case, all above options not fit your needs. You could write a custom relation fields to handle.</p>

<h3 id="example-1-custom-presentation">Example 1: Custom presentation</h3>
<p>For this example, take a look on <a href="https://www.django-rest-framework.org/api-guide/relations/#example_1">document</a> where create a custom relation field named <strong>“TrackListingField”</strong> extends from <strong>“serializers.RelatedField”</strong> then override method <strong>“to_representation“</strong></p>

<h3 id="example-2-read-write-relation-fields-with-nested-serializer">Example 2: Read-write relation fields with nested serializer</h3>
<p>For this example, let’s start with this context:</p>

<p>I have class <strong>TrackSerializer</strong> as above on nested serializer, but I don’t want it just use for readonly by default, I want a <strong>read-write</strong> relation fields which could help me read and write in clean way.</p>

<p>From the guide, I will implement <strong>“.to_internal_value()”</strong> method to help it could be writable. And implement <strong>“.to_representation()”</strong> method to present the data.</p>

<p>So, it could look like this:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">CustomRelatedField</span><span class="p">(</span><span class="n">serializers</span><span class="p">.</span><span class="n">RelatedField</span><span class="p">):</span>
    <span class="s">"""Custom Related Field for Read and Write"""</span>

    <span class="k">def</span> <span class="nf">to_representation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">to_internal_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">pass</span>
</code></pre></div></div>

<h4 id="implement-to_presentation-method"><strong>Implement to_presentation method</strong></h4>

<p>As I want to use serializer class to present the data, then will need a way to get the serializer class from input of the field, then I decided to put it as a part of keyword arguments kwargs.</p>

<p>Above class could be like this:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">CustomRelatedField</span><span class="p">(</span><span class="n">serializers</span><span class="p">.</span><span class="n">RelatedField</span><span class="p">):</span>
    <span class="s">"""Related Field with Serializer Class for presentation"""</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">serializer_class</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">.</span><span class="n">pop</span><span class="p">(</span><span class="s">"serializer_class"</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">.</span><span class="n">serializer_class</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="s">"serializer_class is required"</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">().</span><span class="n">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">to_representation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">serializer_class</span><span class="p">(</span><span class="n">value</span><span class="p">).</span><span class="n">data</span>
</code></pre></div></div>

<p>As above, we able to present object with nested serializer class.</p>

<h4 id="implement-to_internal_value-method"><strong>Implement to_internal_value method</strong></h4>

<p>To help the relation field writable, to_internal_value must be implement. Because this method help decide the data to write to relation models.</p>

<p>There are 2 case of relationships here should be concern:</p>

<p>– ForeignKey in model stands for 1 to many relation</p>

<p>– ManyToManyField in model stands for many to many relation</p>

<p>As example of this post, the tracks belong to 1 to many relations.</p>

<p>One album able to have multiple tracks and 1 track belong to 1 album.</p>

<p><strong>1 to many relation</strong></p>

<p>As 1-n relation, I could get the album by id and set it as value to the write.</p>

<p>The to_internal_value could looks like:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">to_internal_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">get_queryset</span><span class="p">().</span><span class="n">get</span><span class="p">(</span><span class="n">uuid</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
</code></pre></div></div>
<p>Then we have full custom relation fields for a ForeignKey field as FKRelationField below:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ForeignKeyRelationField</span><span class="p">(</span><span class="n">serializers</span><span class="p">.</span><span class="n">RelatedField</span><span class="p">):</span>
    <span class="s">"""Related Field with Serializer Class for presentation"""</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">serializer_class</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">.</span><span class="n">pop</span><span class="p">(</span><span class="s">"serializer_class"</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">().</span><span class="n">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">to_representation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">serializer_class</span><span class="p">(</span><span class="n">value</span><span class="p">).</span><span class="n">data</span>

    <span class="k">def</span> <span class="nf">to_internal_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">get_queryset</span><span class="p">().</span><span class="n">get</span><span class="p">(</span><span class="n">uuid</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
</code></pre></div></div>

<p>I changed the name class from “CustomRelatedField” to “ForeignKeyRelationField” in this case.</p>

<p><strong>many to many relation</strong></p>

<p>Many to many relation will similar to FK with minor change of internal value will be a list of ids instead of single object then each object will return an id instead.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">to_internal_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">get_queryset</span><span class="p">().</span><span class="n">get</span><span class="p">(</span><span class="n">uuid</span><span class="o">=</span><span class="n">data</span><span class="p">).</span><span class="nb">id</span>
</code></pre></div></div>

<p>You could named this field ManyToManyRelationField.</p>

<h2 id="using-custom-relation-field">Using custom relation field</h2>

<p>As above example, I could use my ForeignKeyRelationField on TrackSerializer to read and write the album</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">TrackSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="p">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Track</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s">'title'</span><span class="p">,</span> <span class="s">'album'</span><span class="p">]</span>

    <span class="n">album</span> <span class="o">=</span> <span class="n">ForeignKeyRelatedField</span><span class="p">(</span>
        <span class="n">many</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">queryset</span><span class="o">=</span><span class="n">Album</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="nb">all</span><span class="p">(),</span>
        <span class="n">serializer_class</span><span class="o">=</span><span class="n">AlbumSerializer</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></div>

<p>Above serializer could help represent album with nested serializer AlbumSerializer as well as write the album of a track.</p>

<p>And for “tracks” in AlbumSerializer, could use ManyToManyFieldRelationField to read and write for relation many to many.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">AlbumSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="p">.</span><span class="n">ModelSerializer</span><span class="p">):</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Album</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s">'album_name'</span><span class="p">,</span> <span class="s">'tracks'</span><span class="p">]</span>

    <span class="n">tracks</span> <span class="o">=</span> <span class="n">ManyManyKeyRelatedField</span><span class="p">(</span>
        <span class="n">many</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">queryset</span><span class="o">=</span><span class="n">Track</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="nb">all</span><span class="p">(),</span>
        <span class="n">serializer_class</span><span class="o">=</span><span class="n">TrackSerializer</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></div>

<p>In this post, I have give you more detail of relational fields and how to custom a relation fields.</p>
