<p><img src="/assets/images/2023/04/2023-04-export-multiple-csv-to-zip-django-cover.png" alt="" /></p>

<p>In this next installment of the Django export series, I will be demonstrating how to create a <code class="language-plaintext highlighter-rouge">zip</code> file containing multiple CSV files. Throughout the post, we will explore various methods, providing you with a range of options to consider for your own project.</p>

<h2 id="models-example">Models example</h2>
<p>Let’s consider a basic library system in which a book can be associated with multiple libraries.</p>

<p>The corresponding models are structured as follows:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Library</span><span class="p">(</span><span class="n">models</span><span class="p">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">TextField</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">Book</span><span class="p">(</span><span class="n">models</span><span class="p">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">TextField</span><span class="p">()</span>
    <span class="n">libraries</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">ManyToManyField</span><span class="p">(</span>
        <span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="n">to</span><span class="o">=</span><span class="s">'Library'</span><span class="p">,</span>
        <span class="n">related_name</span><span class="o">=</span><span class="s">'books'</span>
    <span class="p">)</span>
</code></pre></div></div>

<p>Our objective is to export a zip file that contains several CSV files, each one representing a library and displaying a list of books available in that library.</p>

<h3 id="export-view">Export view</h3>

<p>As is typical when creating a download API, we will create a view that only allows the GET method.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">csv</span><span class="p">,</span> <span class="n">io</span><span class="p">,</span> <span class="n">zipfile</span>
<span class="kn">from</span> <span class="nn">wsgiref.util</span> <span class="kn">import</span> <span class="n">FileWrapper</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">StreamingHttpResponse</span>
<span class="kn">from</span> <span class="nn">rest_framework.views</span> <span class="kn">import</span> <span class="n">APIView</span>

<span class="k">class</span> <span class="nc">ExportZip</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">csv_datas</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">build_multiple_csv_files</span><span class="p">()</span>

        <span class="n">temp_file</span> <span class="o">=</span> <span class="n">io</span><span class="p">.</span><span class="n">BytesIO</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">zipfile</span><span class="p">.</span><span class="n">ZipFile</span><span class="p">(</span>
             <span class="n">temp_file</span><span class="p">,</span> <span class="s">"w"</span><span class="p">,</span> <span class="n">zipfile</span><span class="p">.</span><span class="n">ZIP_DEFLATED</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">temp_file_opened</span><span class="p">:</span>
            <span class="c1"># add csv files each library
</span>            <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">csv_datas</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="s">"csv_file"</span><span class="p">].</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">temp_file_opened</span><span class="p">.</span><span class="n">writestr</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s">"library_</span><span class="si">{</span><span class="n">data</span><span class="p">[</span><span class="s">'library_name'</span><span class="p">]</span><span class="si">}</span><span class="s">.csv"</span><span class="p">,</span>
                    <span class="n">data</span><span class="p">[</span><span class="s">"csv_file"</span><span class="p">].</span><span class="n">getvalue</span><span class="p">()</span>
                <span class="p">)</span>

        <span class="n">temp_file</span><span class="p">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># put them to streaming content response
</span>        <span class="c1"># within zip content_type
</span>        <span class="n">response</span> <span class="o">=</span> <span class="n">StreamingHttpResponse</span><span class="p">(</span>
            <span class="n">FileWrapper</span><span class="p">(</span><span class="n">temp_file</span><span class="p">),</span>
            <span class="n">content_type</span><span class="o">=</span><span class="s">"application/zip"</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">response</span><span class="p">[</span><span class="s">'Content-Disposition'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'attachment;filename=Libraries.zip'</span>
        <span class="k">return</span> <span class="n">response</span>

    <span class="k">def</span> <span class="nf">build_multiple_csv_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">csv_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="n">csv_files</span>
</code></pre></div></div>

<p>In the aforementioned view, we utilize the Python Standard Library’s <a href="https://docs.python.org/3/library/zipfile.html"><code class="language-plaintext highlighter-rouge">zipfile</code> module</a> for compressing and archiving data.</p>

<p>The <a href="https://docs.python.org/3/library/zipfile.html#zipfile.ZipFile"><code class="language-plaintext highlighter-rouge">zipfile.ZipFile</code></a> method enables us to open a zip file for writing. In this instance, the file is a binary I/O object, specified as <code class="language-plaintext highlighter-rouge">temp_file_opened</code>, with the <code class="language-plaintext highlighter-rouge">temp_file</code> object being its <a href="https://docs.python.org/3/library/io.html#module-io">file-like</a> equivalent.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">zipfile</span><span class="p">.</span><span class="n">ZipFile</span><span class="p">(</span>
    <span class="nb">file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">'r'</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="n">ZIP_STORED</span><span class="p">,</span>
    <span class="n">allowZip64</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">compresslevel</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span> <span class="n">strict_timestamps</span><span class="o">=</span><span class="bp">True</span>
<span class="p">)</span>
</code></pre></div></div>

<p>We utilize a context manager via the <code class="language-plaintext highlighter-rouge">"with"</code> statement to guarantee the closure of our zip file after the suite within the “with” block has been executed, even if an exception is raised.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">temp_file</span> <span class="o">=</span> <span class="n">io</span><span class="p">.</span><span class="n">BytesIO</span><span class="p">()</span>
<span class="k">with</span> <span class="n">zipfile</span><span class="p">.</span><span class="n">ZipFile</span><span class="p">(</span>
    <span class="n">temp_file</span><span class="p">,</span> <span class="s">"w"</span><span class="p">,</span> <span class="n">zipfile</span><span class="p">.</span><span class="n">ZIP_DEFLATED</span>
<span class="p">)</span> <span class="k">as</span> <span class="n">temp_file_opened</span><span class="p">:</span>
    <span class="c1"># write to zip file
</span></code></pre></div></div>

<p>Within the context manager, we write the CSV content file to the zip <code class="language-plaintext highlighter-rouge">temp_file_opened</code> using the <code class="language-plaintext highlighter-rouge">writestr</code> method.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ZipFile</span><span class="p">.</span><span class="n">writestr</span><span class="p">(</span>
    <span class="n">zinfo_or_arcname</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
    <span class="n">compress_type</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">compresslevel</span><span class="o">=</span><span class="bp">None</span>
<span class="p">)</span>
</code></pre></div></div>

<p>Here, we specify two mandatory parameters - <code class="language-plaintext highlighter-rouge">zinfo_or_arcname</code> and <code class="language-plaintext highlighter-rouge">data</code>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">temp_file_opened</span><span class="p">.</span><span class="n">writestr</span><span class="p">(</span>
    <span class="sa">f</span><span class="s">"File_library_</span><span class="si">{</span><span class="nb">file</span><span class="p">[</span><span class="s">'lib'</span><span class="p">]</span><span class="si">}</span><span class="s">.csv"</span><span class="p">,</span>
    <span class="nb">file</span><span class="p">[</span><span class="s">"csv_file"</span><span class="p">].</span><span class="n">getvalue</span><span class="p">()</span>
<span class="p">)</span>
</code></pre></div></div>

<p>Once we have completed writing multiple CSV files, we locate the zip file by using <a href="https://docs.python.org/3/library/io.html#io.IOBase.seek">seek</a>. We then convert the file-like objects to an iterator using <a href="http://filewrapper/">FileWrapper</a> before returning them in the StreamingHttpResponse.</p>

<p>At this stage, we can download an empty file named “Libraries.zip”.</p>

<h2 id="build-csv-files">Build CSV files</h2>

<p>As shown, we have defined a method named <code class="language-plaintext highlighter-rouge">"build_multiple_csv_files"</code> that currently returns an empty list. In the following step, we will add the code to this function to generate a list of CSV files.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ExportLibraries</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
    <span class="n">header_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">"name"</span><span class="p">:</span> <span class="s">"Name"</span><span class="p">,</span>
        <span class="s">"library"</span><span class="p">:</span> <span class="s">"Library Name"</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="p">...</span>
        <span class="k">return</span> <span class="n">response</span>

    <span class="k">def</span> <span class="nf">build_multiple_csv_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">libraries</span><span class="p">,</span> <span class="n">books</span><span class="p">):</span>
        <span class="n">csv_files</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">library</span> <span class="ow">in</span> <span class="n">libraries</span><span class="p">.</span><span class="n">iterator</span><span class="p">():</span>
            <span class="n">mem_file</span> <span class="o">=</span> <span class="n">io</span><span class="p">.</span><span class="n">StringIO</span><span class="p">()</span>
            <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="p">.</span><span class="n">DictWriter</span><span class="p">(</span>
                <span class="n">mem_file</span><span class="p">,</span> <span class="n">fieldnames</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">header_data</span><span class="p">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="n">writer</span><span class="p">.</span><span class="n">writerow</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">header_data</span><span class="p">)</span>

            <span class="n">books_in_library</span> <span class="o">=</span> <span class="n">books</span><span class="p">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">libraries__in</span><span class="o">=</span><span class="p">[</span><span class="n">library</span><span class="p">.</span><span class="nb">id</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">book</span> <span class="ow">in</span> <span class="n">books_in_library</span><span class="p">:</span>
                <span class="n">book_row</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">build_book_row</span><span class="p">(</span><span class="n">book</span><span class="p">,</span> <span class="n">library</span><span class="p">)</span>
                <span class="n">writer</span><span class="p">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">book_row</span><span class="p">)</span>

            <span class="n">mem_file</span><span class="p">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">csv_files</span><span class="p">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s">"library_name"</span><span class="p">:</span> <span class="n">library</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                <span class="s">"csv_file"</span><span class="p">:</span> <span class="n">mem_file</span>
            <span class="p">})</span>

        <span class="k">return</span> <span class="n">csv_files</span>

    <span class="k">def</span> <span class="nf">build_book_row</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">book</span><span class="p">,</span> <span class="n">library</span><span class="p">):</span>
        <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">header_data</span><span class="p">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">row</span><span class="p">[</span><span class="s">"name"</span><span class="p">]</span> <span class="o">=</span> <span class="n">book</span><span class="p">.</span><span class="n">name</span>
        <span class="n">row</span><span class="p">[</span><span class="s">"library"</span><span class="p">]</span> <span class="o">=</span> <span class="n">library</span><span class="p">.</span><span class="n">name</span>

        <span class="k">return</span> <span class="n">row</span>
</code></pre></div></div>

<p>Reviewing the code above, we iterate over all libraries and construct a CSV file for each one. This is achieved by initializing a writer object using <code class="language-plaintext highlighter-rouge">csv.DictWriter()</code> and the keys from <code class="language-plaintext highlighter-rouge">header_data</code>.</p>

<p>Here is an example of what <code class="language-plaintext highlighter-rouge">header_data</code> might look like:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">header_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">"name"</span><span class="p">:</span> <span class="s">"Book Name"</span><span class="p">,</span>
    <span class="s">"library"</span><span class="p">:</span> <span class="s">"Library Name"</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Next, we add the header to the writer and utilize a loop to add each book row by row to the writer using the .<code class="language-plaintext highlighter-rouge">write_row()</code> method.</p>

<p>Once the writing is complete, we append an object for each library, with the library’s name included in the object’s name, to help establish the CSV filename along with the file’s contents.</p>

<p>To enable export functionality, you may add this view to the URLs file.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span>
        <span class="s">'export_libraries/'</span><span class="p">,</span>
        <span class="n">ExportLibraries</span><span class="p">.</span><span class="n">as_view</span><span class="p">(),</span>
        <span class="n">name</span><span class="o">=</span><span class="s">"export_libraries"</span>
    <span class="p">)</span>
<span class="p">]</span>
</code></pre></div></div>

<h2 id="unit-test">Unit Test</h2>

<p>The following question is how to verify the output?</p>

<p>It is recommended to carry out this step before implementing the logic, as per the <code class="language-plaintext highlighter-rouge">TDD</code> (Test Driven Development) approach. However, I will demonstrate how the logic works first, as it may help you better understand which components require testing.</p>

<p>I intend to create two unit tests for this:</p>

<p>One for the API: Upon calling the API, a zip file should be exported.
One for the CSV files and their contents: Calling <code class="language-plaintext highlighter-rouge">build_multiple_csv_files()</code> on the view should return a list containing data for each library. At this stage, the content of each CSV file can also be verified row by row.</p>

<p><strong>NOTE</strong>: Please keep in mind that the sample unit tests provided below are solely intended to provide an idea of what they may look like, and you should adapt them according to your specific feature.</p>

<h3 id="test-content-response">Test content response</h3>

<p>This unit test is straightforward; we only need to verify that the API call returns a <code class="language-plaintext highlighter-rouge">200</code> status code and that the exported file is a zip file with the expected name.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">test_export_libraries</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s">'export_libraries'</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span> <span class="ow">is</span> <span class="n">status</span><span class="p">.</span><span class="n">HTTP_200_OK</span>
    <span class="k">assert</span> <span class="n">response</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'Content-Disposition'</span><span class="p">)</span> <span class="o">==</span> <span class="s">"Libraries.zip"</span>
</code></pre></div></div>

<h3 id="test-view-function-to-get-multiple-csv-files">Test view function to get multiple CSV files</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">test_build_csvs_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># assume we mock 2 libraries
</span>    <span class="c1"># library_1, library_2
</span>    <span class="c1"># queryset is books and libraries
</span>    <span class="n">view</span> <span class="o">=</span> <span class="n">ExportRecipesCost</span><span class="p">()</span>
    <span class="n">view</span><span class="p">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">drf_request_for_context</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">user</span><span class="p">)</span>
    <span class="n">csv_files</span> <span class="o">=</span> <span class="n">view</span><span class="p">.</span><span class="n">build_multiple_csv_files</span><span class="p">(</span>
        <span class="n">libraries</span><span class="p">,</span> <span class="n">books</span>
    <span class="p">)</span>
    <span class="c1"># check number of csv files
</span>    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">csv_files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
    <span class="c1"># first csv file
</span>    <span class="k">assert</span> <span class="n">csv_files</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">"library_name"</span><span class="p">]</span> <span class="o">==</span> <span class="n">library_1</span><span class="p">.</span><span class="n">name</span>
    <span class="k">assert</span> <span class="n">csv_files</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">"csv_file"</span><span class="p">]</span>
    <span class="c1"># go check csv content in first file here
</span>
    <span class="c1"># second csv file
</span>    <span class="k">assert</span> <span class="n">csv_files</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">"library_name"</span><span class="p">]</span> <span class="o">==</span> <span class="n">library_2</span><span class="p">.</span><span class="n">name</span>
    <span class="k">assert</span> <span class="n">csv_files</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">"csv_file"</span><span class="p">]</span>
    <span class="c1"># go check csv content in first file here
</span></code></pre></div></div>

<p>I have added some comments in the code to indicate the data we will use for testing. Our approach is to call the view function using a mock DRF request, created using the <code class="language-plaintext highlighter-rouge">drf_request_for_context</code> utility function.</p>

<p>In addition to checking the number of CSV files returned, we can also verify the content of each CSV file based on its header.</p>

<h2 id="optimizing-performance">Optimizing performance</h2>

<p>To improve performance, we can optimize the current solution by using a single loop to prepare all the books data, regardless of the library it belongs to, and then loop through the libraries using this set of data. This approach can significantly reduce processing time.</p>

<p>Instead of solely relying on Django queries, one could use Pandas to flatten the data and make the export process even easier by working with dataframes.</p>

<p>Another improvement could be to handle the export process as a background task, such as a Celery task. Instead of using StreamingHttpResponse to download the file from the browser, we can upload the zip file to a service like S3 and provide the user with a URL or other means of accessing the file. This approach can improve user experience and prevent timeout errors when handling large amounts of data.</p>

<p>(If you have any other ideas for improving performance, please share them with me.)</p>

<h2 id="final-word">Final word</h2>

<p>To summarize, we have explored a method (referred to as “use Django queries”) for exporting a zip file containing multiple CSV files within a Django application. While there is an alternative approach using pandas to export data from a Django app, we may discuss it in the future.</p>
