<p><img src="/assets/images/2023/03/2023-03-export-docx-in-django-cover.png" alt="" /></p>

<p>Exporting file is a commonly used feature that allows users to retrieve their data.</p>

<p>Throughout this series, I will outline various methods for exporting files in a Django application. The exported file formats may include <code class="language-plaintext highlighter-rouge">docx</code>, <code class="language-plaintext highlighter-rouge">csv</code>, <code class="language-plaintext highlighter-rouge">zip</code>, or <code class="language-plaintext highlighter-rouge">pdf</code>.</p>

<p>In this initial post of the series, I will introduce the process of exporting a <code class="language-plaintext highlighter-rouge">docx</code> file. We will be utilizing a library called <code class="language-plaintext highlighter-rouge">python-docx</code> to achieve this.</p>

<h2 id="python-docx">python-docx</h2>
<h3 id="introduction">Introduction</h3>
<p><code class="language-plaintext highlighter-rouge">python-dox</code> is a Python library for creating and updating Microsoft Word (<code class="language-plaintext highlighter-rouge">.docx</code>) files.</p>

<p>Please checkout the <a href="https://python-docx.readthedocs.io/en/latest/">official documentation</a> here.</p>

<p>The fundamental concept behind <code class="language-plaintext highlighter-rouge">python-docx</code> is to create a document object to which you can add content such as paragraphs, headings, page breaks, tables, pictures and styling options like bold or italic.</p>

<p>Example:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">docx</span> <span class="kn">import</span> <span class="n">Document</span>
<span class="n">document</span> <span class="o">=</span> <span class="n">Document</span><span class="p">()</span>
<span class="n">document</span><span class="p">.</span><span class="n">add_paragraph</span><span class="p">(</span><span class="s">'Lorem ipsum dolor sit amet.'</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="installing">Installing</h3>
<p>To install <a href="https://pypi.org/project/python-docx/"><code class="language-plaintext highlighter-rouge">python-docx</code></a>, run command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pip <span class="nb">install </span>python-docx
</code></pre></div></div>

<h3 id="export-view">Export view</h3>

<p>To enable the download of a docx file through an API, we typically create a view that allows only the GET method.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ExportDocx</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># create an empty document object
</span>        <span class="n">document</span> <span class="o">=</span> <span class="n">Document</span><span class="p">()</span>

        <span class="c1"># save document info
</span>        <span class="nb">buffer</span> <span class="o">=</span> <span class="n">io</span><span class="p">.</span><span class="n">BytesIO</span><span class="p">()</span>
        <span class="c1"># save your memory stream
</span>        <span class="n">document</span><span class="p">.</span><span class="n">save</span><span class="p">(</span><span class="nb">buffer</span><span class="p">)</span>
        <span class="c1"># rewind the stream to a file
</span>        <span class="nb">buffer</span><span class="p">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># put them to streaming content response
</span>        <span class="c1"># within docx content_type
</span>        <span class="n">response</span> <span class="o">=</span> <span class="n">StreamingHttpResponse</span><span class="p">(</span>
            <span class="c1"># use the stream's content
</span>            <span class="n">streaming_content</span><span class="o">=</span><span class="nb">buffer</span><span class="p">,</span>
            <span class="n">content_type</span><span class="o">=</span><span class="s">'application/vnd.openxmlformats-officedocument.wordprocessingm'</span>
        <span class="p">)</span>

        <span class="n">response</span><span class="p">[</span><span class="s">'Content-Disposition'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'attachment;filename=Test.docx'</span>
        <span class="n">response</span><span class="p">[</span><span class="s">"Content-Encoding"</span><span class="p">]</span> <span class="o">=</span> <span class="s">'UTF-8'</span>

        <span class="k">return</span> <span class="n">response</span>
</code></pre></div></div>

<p>Once we have created an empty document, the next step is to save it and send it to the response.</p>

<p><code class="language-plaintext highlighter-rouge">python-docx</code> provides a <code class="language-plaintext highlighter-rouge">document.save()</code> method that acceps a stream instead of a file name.</p>

<p>We can initialize an <code class="language-plaintext highlighter-rouge">io.BytesIO()</code> object to store the document information and then send that to the user.</p>

<p>To handle large data and return a response, we use the <code class="language-plaintext highlighter-rouge">StreamingHttpResponse</code> function and set the content type to <code class="language-plaintext highlighter-rouge">application/vnd.openxmlformats-officedocument.wordprocessingm</code> for docx files.</p>

<h2 id="build-document-content">Build document content</h2>

<p>After enable to download an empty docx file, the next step is to begin building the content for the docx. It is recommended to refer to the <code class="language-plaintext highlighter-rouge">python-docx</code> documentation for detailed instructions.</p>

<p>To add header text, you can use the <code class="language-plaintext highlighter-rouge">.add_heading()</code> method, and to add paragraphs, you can use the <code class="language-plaintext highlighter-rouge">.add_paragraph()</code> method.</p>

<p>If you wish to style the text, you can add a run to a paragraph.</p>

<p>As an example, I have created a <code class="language-plaintext highlighter-rouge">build_document()</code> method which builds all the content in the document.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">build_document</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">document</span> <span class="o">=</span> <span class="n">Document</span><span class="p">()</span>

    <span class="c1"># add a header
</span>    <span class="n">document</span><span class="p">.</span><span class="n">add_heading</span><span class="p">(</span><span class="s">"This is a header"</span><span class="p">)</span>

    <span class="c1"># add a paragraph
</span>    <span class="n">document</span><span class="p">.</span><span class="n">add_paragraph</span><span class="p">(</span><span class="s">"This is a normal style paragraph"</span><span class="p">)</span>

    <span class="c1"># add a paragraph within an italic text then go on with a break.
</span>    <span class="n">paragraph</span> <span class="o">=</span> <span class="n">document</span><span class="p">.</span><span class="n">add_paragraph</span><span class="p">()</span>
    <span class="n">run</span> <span class="o">=</span> <span class="n">paragraph</span><span class="p">.</span><span class="n">add_run</span><span class="p">()</span>
    <span class="n">run</span><span class="p">.</span><span class="n">italic</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">run</span><span class="p">.</span><span class="n">add_text</span><span class="p">(</span><span class="s">"text will have italic style"</span><span class="p">)</span>
    <span class="n">run</span><span class="p">.</span><span class="n">add_break</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">document</span>
</code></pre></div></div>

<p>I will then replace the code that creates an empty document in the view with the following:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">document</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">build_document</span><span class="p">()</span>
</code></pre></div></div>

<p>The current export result is shown below:</p>

<p><img src="/assets/images/2023/03/2023-03-export-docx-in-django-img-1-basic.webp" alt="" /></p>

<h2 id="advance---build-html-content">Advance - build html content</h2>

<p>Essentially, I can export a docx file with content in it.</p>

<p>To begin with, I simply add the content within a paragraph:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># add paragraph for html content
</span><span class="n">document</span><span class="p">.</span><span class="n">add_paragraph</span><span class="p">(</span><span class="s">"&lt;p&gt;Nice to see Prep note 2&lt;/p&gt;&lt;ul&gt;&lt;li&gt;Prep note 2 content 1&lt;/li&gt;&lt;li&gt;Prep note 2 content 2&lt;/li&gt;&lt;/ul&gt;"</span><span class="p">)</span>
</code></pre></div></div>

<p>However, there was a strange display as following:</p>

<p><img src="/assets/images/2023/03/2023-03-export-docx-in-django-img-2-issue-html.webp" alt="" /></p>

<p>I need to find a way to convert HTML content to plain text while preserving basic formatting such as italics, bolding, and bullet points. Here’s an example:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Nice to see Prep note 2
    ●    Prep note 2 content 1
    ●    Prep note 2 content 2
</code></pre></div></div>

<p>After research around, I discovered a Python built-in library called <a href="https://docs.python.org/3/library/html.parser.html"><code class="language-plaintext highlighter-rouge">html.parser</code></a> - Simple HTML and XHTML parser.</p>

<p>Followed <a href="https://github.com/python-openxml/python-docx/issues/352">an examle</a> to create a class called <code class="language-plaintext highlighter-rouge">DocumentHTMLParser</code> to handle it, as shown below:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">DocumentHTMLParser</span><span class="p">(</span><span class="n">HTMLParser</span><span class="p">):</span>
    <span class="s">"""
    Document Within HTML Parser
    """</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">document</span><span class="p">):</span>
        <span class="s">"""
        Override __init__ method
        """</span>
        <span class="n">HTMLParser</span><span class="p">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">document</span> <span class="o">=</span> <span class="n">document</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">paragraph</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">run</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">add_paragraph_and_feed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">html</span><span class="p">):</span>
        <span class="s">"""
        Custom method where add paragraph and feed
        """</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">paragraph</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">document</span><span class="p">.</span><span class="n">add_paragraph</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">feed</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">handle_starttag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="s">"""
        Override handle_starttag method
        """</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">run</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">paragraph</span><span class="p">.</span><span class="n">add_run</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">tag</span> <span class="ow">in</span> <span class="p">[</span><span class="s">"ul"</span><span class="p">]:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">run</span><span class="p">.</span><span class="n">add_break</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">tag</span> <span class="ow">in</span> <span class="p">[</span><span class="s">"li"</span><span class="p">]:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">run</span><span class="p">.</span><span class="n">add_text</span><span class="p">(</span><span class="sa">u</span><span class="s">'        </span><span class="se">\u2022</span><span class="s">    '</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">handle_endtag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">):</span>
        <span class="s">"""
        Override handle_endtag method
        """</span>
        <span class="k">if</span> <span class="n">tag</span> <span class="ow">in</span> <span class="p">[</span><span class="s">"li"</span><span class="p">]:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">run</span><span class="p">.</span><span class="n">add_break</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">handle_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="s">"""Override handle_data method"""</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">run</span><span class="p">.</span><span class="n">add_text</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</code></pre></div></div>

<p>The code above involves overriding a function in the HTMLParser class and using the paragraph’s run to customize its style based on the starting tag.</p>

<p>If a tag needs to break on the end, we add a break for it.</p>

<p>I then utilized this custom class in my view to handle the HTML content:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">build_document</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s">"""Build content document"""</span>
    <span class="n">document</span> <span class="o">=</span> <span class="n">Document</span><span class="p">()</span>
    <span class="n">doc_html_parser</span> <span class="o">=</span> <span class="n">DocumentHTMLParser</span><span class="p">(</span><span class="n">document</span><span class="p">)</span>

    <span class="c1"># add a header
</span>    <span class="n">document</span><span class="p">.</span><span class="n">add_heading</span><span class="p">(</span><span class="s">"This is a header"</span><span class="p">)</span>

    <span class="c1"># add a paragraph
</span>    <span class="n">document</span><span class="p">.</span><span class="n">add_paragraph</span><span class="p">(</span><span class="s">"This is a normal style paragraph"</span><span class="p">)</span>

    <span class="c1"># add a paragraph within an italic text then go on with a break.
</span>    <span class="n">paragraph</span> <span class="o">=</span> <span class="n">document</span><span class="p">.</span><span class="n">add_paragraph</span><span class="p">()</span>
    <span class="n">run</span> <span class="o">=</span> <span class="n">paragraph</span><span class="p">.</span><span class="n">add_run</span><span class="p">()</span>
    <span class="n">run</span><span class="p">.</span><span class="n">italic</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">run</span><span class="p">.</span><span class="n">add_text</span><span class="p">(</span><span class="s">"text will have italic style"</span><span class="p">)</span>
    <span class="n">run</span><span class="p">.</span><span class="n">add_break</span><span class="p">()</span>

    <span class="c1"># with html content, call method add_paragraph_and_feed tui build content
</span>    <span class="n">html_content</span> <span class="o">=</span> <span class="s">"&lt;p&gt;Nice to see Prep note 2&lt;/p&gt;&lt;ul&gt;&lt;li&gt;Prep note 2 content 1&lt;/li&gt;&lt;li&gt;Prep note 2 content 2&lt;/li&gt;&lt;/ul&gt;"</span>
    <span class="n">doc_html_parser</span><span class="p">.</span><span class="n">add_paragraph_and_feed</span><span class="p">(</span><span class="n">html_content</span><span class="p">)</span>
</code></pre></div></div>

<p>Here’s the resulting docx file from the HTML content:
<img src="/assets/images/2023/03/2023-03-export-docx-in-django-img-3-export-docx-html.webpp" alt="" /></p>

<h2 id="unit-test">Unit Test</h2>

<p>On the backend side, unit testing is a crucial component to protect your application. In my project, each pull request requires a minimum of 80% code coverage through testing, making unit testing a mandatory part of the development process. To aid in writing unit tests, we utilize libraries such as <a href="https://factoryboy.readthedocs.io/en/stable/">factory_boy</a> and <a href="https://docs.pytest.org/en/stable/">pytest</a>. If you’re unfamiliar with these libraries, you can check out the links provided before proceeding.</p>

<p>In this section, I won’t be covering how to use or write unit tests for a Django application. Instead, I will ensure that the exported docx file has the correct name and type, and that the file contains the expected content and style.</p>

<h3 id="test-content-response">Test content response</h3>

<p>I performed some basic checks on the exported file, such as verifying the response status, content type, and file name.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">test_export_docx_general</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s">"""
    Ensure general content like
    status response, content type, file name exported correctly
    """</span>
    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s">"export_docx"</span><span class="p">))</span>
    <span class="kn">import</span> <span class="nn">pdb</span><span class="p">;</span><span class="n">pdb</span><span class="p">.</span><span class="n">set_trace</span><span class="p">()</span>
</code></pre></div></div>

<p>By using <code class="language-plaintext highlighter-rouge">import pdb;pdb.set_trace()</code> after making the <code class="language-plaintext highlighter-rouge">GET</code> request in the unit test, I am able to inspect the current data.</p>

<p>Here is an example of what it looks like:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;django.http.response.StreamingHttpResponse object at 0x7fc392a61990&gt;
<span class="o">(</span>Pdb<span class="o">)</span> response.status_code
200
<span class="o">(</span>Pdb<span class="o">)</span> response.streaming_content
&lt;map object at 0x7fc3927aadd0&gt;
<span class="o">(</span>Pdb<span class="o">)</span> response.streaming_content.__dir__<span class="o">()</span>
<span class="o">[</span><span class="s1">'__getattribute__'</span>, <span class="s1">'__iter__'</span>, <span class="s1">'__next__'</span>, <span class="s1">'__new__'</span>, <span class="s1">'__reduce__'</span>, <span class="s1">'__doc__'</span>, <span class="s1">'__repr__'</span>, <span class="s1">'__hash__'</span>, <span class="s1">'__str__'</span>, <span class="s1">'__setattr__'</span>, <span class="s1">'__delattr__'</span>, <span class="s1">'__lt__'</span>, <span class="s1">'__le__'</span>, <span class="s1">'__eq__'</span>, <span class="s1">'__ne__'</span>, <span class="s1">'__gt__'</span>, <span class="s1">'__ge__'</span>, <span class="s1">'__init__'</span>, <span class="s1">'__reduce_ex__'</span>, <span class="s1">'__subclasshook__'</span>, <span class="s1">'__init_subclass__'</span>, <span class="s1">'__format__'</span>, <span class="s1">'__sizeof__'</span>, <span class="s1">'__dir__'</span>, <span class="s1">'__class__'</span><span class="o">]</span>
<span class="o">(</span>Pdb<span class="o">)</span> response.get<span class="o">(</span><span class="s2">"Content-Type"</span><span class="o">)</span>
<span class="s1">'application/vnd.openxmlformats-officedocument.wordprocessingm'</span>
<span class="o">(</span>Pdb<span class="o">)</span> response.get<span class="o">(</span><span class="s2">"Content-Disposition"</span><span class="o">)</span>
<span class="s1">'attachment;filename=Recipe_Pho_2021-04-15-14-34-09.docx'</span>
</code></pre></div></div>

<p>As seen in the previous code block, I can continue writing unit tests to check the exported file’s general content, such as the file’s content type, status code, and name.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">test_export_docx_general</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s">"""
    Ensure general content like
    status response, content type, file name exported correctly
    """</span>
    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s">"export_docx"</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="n">status</span><span class="p">.</span><span class="n">HTTP_200_OK</span>
    <span class="k">assert</span> <span class="n">response</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"Content-Type"</span><span class="p">)</span> <span class="o">==</span> \
        <span class="s">"application/vnd.openxmlformats-officedocument.wordprocessingm"</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"Content-Disposition"</span><span class="p">).</span><span class="n">split</span><span class="p">(</span><span class="s">"="</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">filename</span> <span class="o">==</span> <span class="s">"Test.docx"</span>
</code></pre></div></div>

<p>Please note the <code class="language-plaintext highlighter-rouge">response.streaming_content</code> object above which appears as a map object without any data for testing. Initially, I was unsure about how to test the content and style of the document accurately. Despite researching various options, I could not find a suitable solution. Eventually, I came up with a solution for testing the built document myself, which is as follows:</p>

<h3 id="test-document-content">Test document content</h3>

<p>I have created a function in the code called <code class="language-plaintext highlighter-rouge">build_document</code> to build the document, which is now ready for testing:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">build_document</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s">"""Build content document"""</span>
    <span class="n">document</span> <span class="o">=</span> <span class="n">Document</span><span class="p">()</span>
    <span class="n">doc_html_parser</span> <span class="o">=</span> <span class="n">DocumentHTMLParser</span><span class="p">(</span><span class="n">document</span><span class="p">)</span>

    <span class="c1"># with html content, call method add_paragraph_and_feed tui build content
</span>    <span class="n">html_content</span> <span class="o">=</span> <span class="s">"&lt;p&gt;Nice to see Prep note 2&lt;/p&gt;&lt;ul&gt;&lt;li&gt;Prep note 2 content 1&lt;/li&gt;&lt;li&gt;Prep note 2 content 2&lt;/li&gt;&lt;/ul&gt;"</span>
    <span class="n">doc_html_parser</span><span class="p">.</span><span class="n">add_paragraph_and_feed</span><span class="p">(</span><span class="n">html_content</span><span class="p">)</span>
</code></pre></div></div>

<p>My solution was to directly call this function for testing on a mocked view.</p>

<p>Here’s how it appears in the test function:</p>

<pre><code class="language-pyhton">def test_build_document_for_docx(self):
    """Ensure document built content and style correctly"""
    # inline import just for you know where they are
    from django.http import HttpRequest
    from rest_framework.request import Request as DRFRequest

    # mock drf request
    request = HttpRequest()
    request.method = 'GET'
    drf_request = DRFRequest(request)
    drf_request.user = self.user

    # mock view with request
    view = ExportRecipesDocx()
    view.request = request

    # call function in view directly
    document = view.build_document()
    import pdb;pdb.set_trace()
</code></pre>

<p>Once again, I checked the document profile. As an example, I just have a personal curiosity and love to explore what they are 🥰.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(</span>Pdb<span class="o">)</span> document
&lt;docx.document.Document object at 0x7fd5e65140a0&gt;
<span class="o">(</span>Pdb<span class="o">)</span> document._body.paragraphs
<span class="o">[</span>&lt;docx.text.paragraph.Paragraph object at 0x7fd5e5d5fb50&gt;]
<span class="o">(</span>Pdb<span class="o">)</span> document._body.paragraphs[0].runs
<span class="o">[</span>&lt;docx.text.run.Run object at 0x7fd5e5e419d0&gt;, &lt;docx.text.run.Run object at 0x7fd5e5eba6d0&gt;, &lt;docx.text.run.Run object at 0x7fd5e5eba410&gt;, &lt;docx.text.run.Run object at 0x7fd5e5eba3d0&gt;]
<span class="o">(</span>Pdb<span class="o">)</span> document._body.paragraphs[0].runs[0].text
<span class="s1">'Nice to see Prep note 2\n'</span>
<span class="o">(</span>Pdb<span class="o">)</span> document._body.paragraphs[0].runs[0].style.name
<span class="s1">'Default Paragraph Font'</span>
<span class="o">(</span>Pdb<span class="o">)</span> document._body.paragraphs[0].runs[0].style.priority
1
<span class="o">(</span>Pdb<span class="o">)</span> document._body.paragraphs[0].runsp[1].text
</code></pre></div></div>

<p>In my current <code class="language-plaintext highlighter-rouge">build_document</code> method, I create a paragraph and add some runs to it, while also inserting breaks where necessary based on the start and end tags of the HTML.</p>

<p>Below is the final version of my unit test for checking the document’s content and styles:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">test_build_document_for_docx</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s">"""Ensure document built content and style correctly"""</span>
    <span class="c1"># mock request and view initialize like above code
</span>    <span class="c1"># ...
</span>    <span class="c1"># call function in view directly
</span>    <span class="n">document</span> <span class="o">=</span> <span class="n">view</span><span class="p">.</span><span class="n">build_document</span><span class="p">()</span>

    <span class="n">paragraphs</span> <span class="o">=</span> <span class="n">document</span><span class="p">.</span><span class="n">_body</span><span class="p">.</span><span class="n">paragraphs</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">paragraphs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">paragraphs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">style</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">"Normal"</span>
    <span class="k">assert</span> <span class="n">paragraphs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">style</span><span class="p">.</span><span class="n">priority</span> <span class="ow">is</span> <span class="bp">None</span>
    <span class="k">assert</span> <span class="p">[</span>
        <span class="s">'Nice to see Prep note 2'</span><span class="p">,</span>
        <span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">,</span>
        <span class="s">'        •    Prep note 2 content 1</span><span class="se">\n</span><span class="s">'</span><span class="p">,</span>
        <span class="s">'        •    Prep note 2 content 2</span><span class="se">\n</span><span class="s">'</span>
    <span class="p">]</span> <span class="o">==</span> <span class="p">[</span><span class="n">item</span><span class="p">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">paragraphs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">runs</span><span class="p">]</span>
    <span class="k">assert</span> <span class="p">{</span><span class="bp">None</span><span class="p">}</span> <span class="o">==</span> <span class="p">{</span><span class="n">item</span><span class="p">.</span><span class="n">italic</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">paragraphs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">runs</span><span class="p">}</span>
    <span class="k">assert</span> <span class="p">{</span><span class="bp">None</span><span class="p">}</span> <span class="o">==</span> <span class="p">{</span><span class="n">item</span><span class="p">.</span><span class="n">bold</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">paragraphs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">runs</span><span class="p">}</span>
</code></pre></div></div>

<p>Exporting files in a Django app is a fascinating process, and Python has several libraries that are useful for handling content formats.</p>

<h2 id="final-word">Final word</h2>
<p>In this article, we discussed a straightforward example of exporting docx files within a Django app.</p>
